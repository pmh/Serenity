var machina=function(a,b){if(!a.deepExtend){var c={"*":function(a,b,c){a[b]=c},object:function(a,b,c){a[b]=f(a[b]||{},c)},array:function(b,d,f){b[d]=[],a.each(f,function(a,f){c[e(a)](b[d],f,a)},this)}},d=function(b){return a.isArray(b)?"array":a.isDate(b)?"date":a.isRegExp(b)?"regex":typeof b},e=function(a){var b=d(a);return c[b]?b:"*"},f=function(b){return a.each(g.call(arguments,1),function(d){a.each(d,function(a,d){c[e(a)](b,d,a)})}),b};a.mixin({deepExtend:f})}var g=[].slice,h="transition",i="handler",j=function(b){var c={};return a.each(b,function(a){c[a]=[]}),c},k=function(b){var c=b;return a.isArray(b)&&(c=j(b)),c},l={getHandlerNames:function(b){return a.uniq(a.flatten(a.map(b.states,function(b){return a.keys(b)})))},findProvider:function(){return window.postal?"postal":window.amplify?"amplify":b},makeFsmNamespace:function(){var a=0;return function(){return"fsm."+a++}}(),getDefaultOptions:function(){return{initialState:"uninitialized",eventListeners:{"*":[]},states:{},eventQueue:[],messaging:function(){var a=l.makeFsmNamespace();return{provider:l.findProvider(),eventNamespace:a+".events",handlerNamespace:a,subscriptions:[]}}()}},standardEventTransforms:{Handling:function(a){var b=a;return b.eventType=b[1],delete b[1],b},Handled:function(a){var b=a;return b.eventType=b[1],delete b[1],b},Transitioned:function(a){var b=a;return b.oldState=b[1],b.newState=b[2],delete b[1],delete b[2],b},InvalidState:function(a){var b=a;return b.currentState=b[1],b.attemptedState=b[2],delete b[1],delete b[2],b},NoHandler:function(a){var b=a;return b.eventType=b[1],delete b[1],b}}},m={},n=function(){var b={},c=function(a){a.messaging.subscriptions.push(postal.subscribe(a.messaging.handlerNamespace,"*",function(a,b){this.handle.call(this,b.topic,a)}).withContext(a))},d=function(c){c.messaging.eventPublisher=function(){var d=arguments[0],e=a.deepExtend({},g.call(arguments,1));b[d]&&(e=b[d](e)),postal.publish(c.messaging.eventNamespace,d,e)},c.on("*",c.messaging.eventPublisher)};return{wireUp:function(a){c(a),d(a)},addEventTransforms:function(c){a.deepExtend(b,c)}}};m.postal=new n,m.postal.addEventTransforms(l.standardEventTransforms);var o=function(){var b={},c=function(b){a.each(l.getHandlerNames(b),function(a){b.messaging.subscriptions.push(amplify.subscribe(b.messaging.handlerNamespace+"."+a,b,function(b){this.handle.call(this,a,b)}))})},d=function(c){c.messaging.eventPublisher=function(){var d=arguments[0],e=a.deepExtend({},g.call(arguments,1));b[d]&&(e=b[d](e)),amplify.publish(c.messaging.eventNamespace+"."+d,e)},c.on("*",c.messaging.eventPublisher)};return{wireUp:function(a){c(a),d(a)},addEventTransforms:function(c){a.deepExtend(b,c)}}};m.amplify=new o,m.amplify.addEventTransforms(l.standardEventTransforms);var p=function(c){var d,e,f=l.getDefaultOptions();c&&(c.eventListeners&&(c.eventListeners=k(c.eventListeners)),c.messaging&&(c.messaging=a.extend({},f.messaging,c.messaging))),d=a.extend(f,c||{}),e=d.initialState,delete d.initialState,a.extend(this,d),this.messaging.provider&&m[this.messaging.provider]&&m[this.messaging.provider].wireUp(this),this.state=b,this._priorAction="",this._currentAction="",e&&this.transition(e),q.eventListeners.fireEvent("newFsm",this)};p.prototype.fireEvent=function(b){var c=arguments;a.each(this.eventListeners["*"],function(a){try{a.apply(this,g.call(c,0))}catch(b){console&&typeof console.log!="undefined"&&console.log(b.toString())}}),this.eventListeners[b]&&a.each(this.eventListeners[b],function(a){try{a.apply(this,g.call(c,1))}catch(b){console&&typeof console.log!="undefined"&&console.log(b.toString())}})},p.prototype.handle=function(a){var c=this.states,d=this.state,e=g.call(arguments,0),f;this.currentActionArgs=e,c[d]&&(c[d][a]||c[d]["*"])?(f=c[d][a]?a:"*",this._currentAction=d+"."+f,this.fireEvent.apply(this,["Handling"].concat(e)),c[d][f].apply(this,e.slice(1)),this.fireEvent.apply(this,["Handled"].concat(e)),this._priorAction=this._currentAction,this._currentAction="",this.processQueue(i)):this.fireEvent.apply(this,["NoHandler"].concat(e)),this.currentActionArgs=b},p.prototype.transition=function(a){if(this.states[a]){var b=this.state;this.state=a,this.states[a]._onEnter&&this.states[a]._onEnter.call(this),this.fireEvent.apply(this,["Transitioned",b,this.state]),this.processQueue(h);return}this.fireEvent.apply(this,["InvalidState",this.state,a])},p.prototype.processQueue=function(b){var c=b===h?function(a){return a.type===h&&(!a.untilState||a.untilState===this.state)}:function(a){return a.type===i},d=a.filter(this.eventQueue,c,this);this.eventQueue=a.difference(this.eventQueue,d),a.each(d,function(a,b){this.handle.apply(this,a.args)},this)},p.prototype.deferUntilTransition=function(a){if(this.currentActionArgs){var b={type:h,untilState:a,args:this.currentActionArgs};this.eventQueue.push(b),this.fireEvent.apply(this,["Deferred",this.state,b])}},p.prototype.deferUntilNextHandler=function(){if(this.currentActionArgs){var a={type:h,args:this.currentActionArgs};this.eventQueue.push(a),this.fireEvent.apply(this,["Deferred",this.state,a])}},p.prototype.on=function(a,b){this.eventListeners[a]||(this.eventListeners[a]=[]),this.eventListeners[a].push(b)},p.prototype.off=function(b,c){this.eventListeners[b]&&(this.eventListeners[b]=a.without(this.eventListeners[b],c))};var q={Fsm:p,busProviders:m,utils:l,on:function(a,b){if(this.eventListeners[a]){this.eventListeners[a].push(b);return}throw new Error("Invalid Event Name '"+a+"'.")},off:function(b,c){throw this.eventListeners[b]&&(this.eventListeners[b]=a.without(this.eventListeners[b],c)),new Error("Invalid Event Name '"+b+"'.")},eventListeners:{fireEvent:function(b){var c=0,d,e=arguments;this[b]&&a.each(this[b],function(a){a.apply(null,g.call(e,1))})},newFsm:[]}};return q}(_)
module.exports = machina;